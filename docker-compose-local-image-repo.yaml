---
services:
  api:
    depends_on:
      - controller
      - fortuna
    deploy:
      resources:
        limits:
          memory: 128M
    environment:
      - PORT=8080
      - DB_PATH=/data/api.db
      - CONTROLLER_ADDR=http://controller:8081
      - FORTUNA_ADDR=http://fortuna:8082
      - TRNG_QUEUE_SIZE=100000
      - FORTUNA_QUEUE_SIZE=100000
      - TRNG_POLL_INTERVAL_MS=100
      - FORTUNA_POLL_INTERVAL_MS=100
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-api:latest
    ports:
      - '8080:8080'
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - api-data:/data
  controller:
    deploy:
      resources:
        limits:
          memory: 128M
    devices:
      - /dev/i2c-1:/dev/i2c-1
    environment:
      - PORT=8081
      - I2C_BUS_NUMBER=1
      - FORCE_CONFIG=true
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-controller:latest
    ports:
      - '8081:8081'
    privileged: true
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  fortuna:
    depends_on:
      - controller
    deploy:
      resources:
        limits:
          memory: 128M
    environment:
      - PORT=8082
      - AMPLIFICATION_FACTOR=4
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-fortuna:latest
    ports:
      - '8082:8082'
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
volumes:
  api-data: null
  # This is a templated docker-compose file for running Lokey on a Raspberry Pi Zero 2W
  # Replace ${DEV_MACHINE_IP} with your development machine's IP address or use environment variables