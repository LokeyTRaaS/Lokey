---
networks:
  lokey-internal:
    driver: bridge

x-logging: &logging-common
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-api-common: &api-common
  deploy:
    resources:
      limits:
        memory: 242M # accounts for service (64M) + /data tmpfs (128M) + /app tmpfs (50M)
  networks:
    - lokey-internal
  image: ghcr.io/lokeytraas/lokey/api:prerelease-major-refactor-arm64
  restart: unless-stopped
  logging: *logging-common
  ports:
    - '8080:8080'
  volumes:
    - type: tmpfs
      target: /data
      tmpfs:
        size: 128M
    - type: tmpfs
      target: /app
      tmpfs:
        size: 50M

x-api-env: &api-env
  PORT: 8080
  DB_PATH: /data/api.db
  DB_IMPLEMENTATION: channel
  CONTROLLER_ADDR: http://controller:8081
  FORTUNA_ADDR: http://fortuna:8082
  TRNG_QUEUE_SIZE: 500000 #For raspberry pi zero 2 max 500.000 of 31 bit items
  FORTUNA_QUEUE_SIZE: 10000 #For raspberry pi zero 2 max 1000 of 256 bit items, note that these settings are optimistic and assume the device to solely be used for random number generation.
  TRNG_POLL_INTERVAL_MS: 100
  FORTUNA_POLL_INTERVAL_MS: 100
  VIRTIO_ADDR: http://virtio:8083
  VIRTIO_QUEUE_SIZE: 500000
  VIRTIO_POLL_INTERVAL_MS: 100
  VIRTIO_SEED_INTERVAL_SECONDS: 30
  VIRTIO_SEEDING_SOURCE: trng
  TRNG_APT_WINDOW_SIZE: 512 # APT test window size in bytes (256-2048)

x-controller-common: &controller-common
  deploy:
    resources:
      limits:
        memory: 42M # accounts for service (20M) + /app tmpfs (22M)
  networks:
    - lokey-internal
  devices:
    - /dev/i2c-1:/dev/i2c-1
  image: ghcr.io/lokeytraas/lokey/controller:prerelease-major-refactor-arm64
  privileged: true
  restart: unless-stopped
  logging: *logging-common
  volumes:
    - type: tmpfs
      target: /app
      tmpfs:
        size: 22M

x-controller-env: &controller-env
  PORT: 8081
  I2C_BUS_NUMBER: 1
  FORCE_CONFIG: "false"

x-fortuna-common: &fortuna-common
  deploy:
    resources:
      limits:
        memory: 52M # accounts for service (20M) + /app tmpfs (32M)
  networks:
    - lokey-internal
  image: ghcr.io/lokeytraas/lokey/fortuna:prerelease-major-refactor-arm64
  restart: unless-stopped
  logging: *logging-common
  volumes:
    - type: tmpfs
      target: /app
      tmpfs:
        size: 32M

x-fortuna-env: &fortuna-env
  PORT: 8082
  AMPLIFICATION_FACTOR: 4

x-virtio-common: &virtio-common
  deploy:
    resources:
      limits:
        memory: 52M # accounts for service (20M) + /app tmpfs (32M)
  networks:
    - lokey-internal
  image: ghcr.io/lokeytraas/lokey/virtio:prerelease-major-refactor-arm64
  restart: unless-stopped
  logging: *logging-common
  volumes:
    - type: tmpfs
      target: /app
      tmpfs:
        size: 32M

x-virtio-common-with-devices: &virtio-common-with-devices
  <<: *virtio-common
  devices:
    - /dev/hwrng:/dev/hwrng
    - /dev/random:/dev/random

# Common definitions WITHOUT tmpfs (for local profile)
x-api-common-no-tmpfs: &api-common-no-tmpfs
  deploy:
    resources:
      limits:
        memory: 128M # service only, no tmpfs, 128M if you use the ringbuffer database
  networks:
    - lokey-internal
  image: ghcr.io/lokeytraas/lokey/api:prerelease-major-refactor-arm64
  restart: unless-stopped
  logging: *logging-common
  ports:
    - '8080:8080'

x-controller-common-no-tmpfs: &controller-common-no-tmpfs
  deploy:
    resources:
      limits:
        memory: 20M # service only, no tmpfs
  networks:
    - lokey-internal
  devices:
    - /dev/i2c-1:/dev/i2c-1
  image: ghcr.io/lokeytraas/lokey/controller:prerelease-major-refactor-arm64
  privileged: true
  restart: unless-stopped
  logging: *logging-common

x-fortuna-common-no-tmpfs: &fortuna-common-no-tmpfs
  deploy:
    resources:
      limits:
        memory: 20M # service only, no tmpfs
  networks:
    - lokey-internal
  image: ghcr.io/lokeytraas/lokey/fortuna:prerelease-major-refactor-arm64
  restart: unless-stopped
  logging: *logging-common

x-virtio-common-no-tmpfs: &virtio-common-no-tmpfs
  deploy:
    resources:
      limits:
        memory: 20M # service only, no tmpfs
  networks:
    - lokey-internal
  image: ghcr.io/lokeytraas/lokey/virtio:prerelease-major-refactor-arm64
  restart: unless-stopped
  logging: *logging-common

x-virtio-env: &virtio-env
  PORT: 8083
  RNG_DEVICE: /dev/hwrng
  VIRTIO_QUEUE_SIZE: 15000
  VIRTIO_PIPE_PATH: /var/run/lokey/virtio-rng

x-local-registry-images: &local-registry-images
  api: ${DEV_MACHINE_IP:-localhost}:5000/lokey-api:latest
  controller: ${DEV_MACHINE_IP:-localhost}:5000/lokey-controller:latest
  fortuna: ${DEV_MACHINE_IP:-localhost}:5000/lokey-fortuna:latest
  virtio: ${DEV_MACHINE_IP:-localhost}:5000/lokey-virtio:latest

services:

  api:
    <<: *api-common
    depends_on:
      - controller
      - fortuna
      - virtio
    environment:
      <<: *api-env
      GIN_MODE: release
      LOG_LEVEL: WARN
    profiles:
      - production

  controller:
    <<: *controller-common
    environment:
      <<: *controller-env
      GIN_MODE: release
      LOG_LEVEL: WARN
    profiles:
      - production

  fortuna:
    <<: *fortuna-common
    depends_on:
      - controller
    environment:
      <<: *fortuna-env
      GIN_MODE: release
      LOG_LEVEL: WARN
    profiles:
      - production

  virtio:
    <<: *virtio-common-with-devices
    environment:
      <<: *virtio-env
      GIN_MODE: release
      LOG_LEVEL: WARN
    profiles:
      - production

  api-debug:
    <<: *api-common
    depends_on:
      - controller-debug
      - fortuna-debug
      - virtio-debug
    environment:
      <<: *api-env
      CONTROLLER_ADDR: http://controller-debug:8081
      FORTUNA_ADDR: http://fortuna-debug:8082
      VIRTIO_ADDR: http://virtio-debug:8083
      GIN_MODE: debug
      LOG_LEVEL: DEBUG
    profiles:
      - debug

  controller-debug:
    <<: *controller-common
    environment:
      <<: *controller-env
      GIN_MODE: debug
      LOG_LEVEL: DEBUG
    ports:
      - '8081:8081'
    profiles:
      - debug

  fortuna-debug:
    <<: *fortuna-common
    depends_on:
      - controller-debug
    environment:
      <<: *fortuna-env
      GIN_MODE: debug
      LOG_LEVEL: DEBUG
    ports:
      - '8082:8082'
    profiles:
      - debug

  virtio-debug:
    <<: *virtio-common-with-devices
    environment:
      <<: *virtio-env
      GIN_MODE: debug
      LOG_LEVEL: DEBUG
    ports:
      - '8083:8083'  # HTTP API
    profiles:
      - debug

  # Local registry profile - uses images from local Docker registry (NO tmpfs)
  api-local:
    <<: *api-common-no-tmpfs
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-api:latest
    depends_on:
      - controller-local
      - fortuna-local
      - virtio-local
    environment:
      <<: *api-env
      CONTROLLER_ADDR: http://controller-local:8081
      FORTUNA_ADDR: http://fortuna-local:8082
      VIRTIO_ADDR: http://virtio-local:8083
      GIN_MODE: release
      LOG_LEVEL: WARN
    volumes:
      - api-data-local:/data
    profiles:
      - local

  controller-local:
    <<: *controller-common-no-tmpfs
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-controller:latest
    environment:
      <<: *controller-env
      FORCE_CONFIG: "true"
      GIN_MODE: release
      LOG_LEVEL: WARN
    ports:
      - '8081:8081'
    profiles:
      - local

  fortuna-local:
    <<: *fortuna-common-no-tmpfs
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-fortuna:latest
    depends_on:
      - controller-local
    environment:
      <<: *fortuna-env
      GIN_MODE: release
      LOG_LEVEL: WARN
    ports:
      - '8082:8082'
    profiles:
      - local

  virtio-local:
    <<: *virtio-common-no-tmpfs
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-virtio:latest
    environment:
      <<: *virtio-env
      GIN_MODE: release
      LOG_LEVEL: WARN
    ports:
      - '8083:8083'  # HTTP API
    profiles:
      - local

  # Local registry profile WITH tmpfs - optimized for Raspberry Pi (reduced disk I/O)
  api-local-tmpfs:
    <<: *api-common
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-api:latest
    depends_on:
      - controller-local-tmpfs
      - fortuna-local-tmpfs
      - virtio-local-tmpfs
    environment:
      <<: *api-env
      CONTROLLER_ADDR: http://controller-local-tmpfs:8081
      FORTUNA_ADDR: http://fortuna-local-tmpfs:8082
      VIRTIO_ADDR: http://virtio-local-tmpfs:8083
      GIN_MODE: release
      LOG_LEVEL: WARN
    profiles:
      - local-tmpfs

  controller-local-tmpfs:
    <<: *controller-common
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-controller:latest
    environment:
      <<: *controller-env
      FORCE_CONFIG: "true"
      GIN_MODE: release
      LOG_LEVEL: WARN
    ports:
      - '8081:8081'
    profiles:
      - local-tmpfs

  fortuna-local-tmpfs:
    <<: *fortuna-common
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-fortuna:latest
    depends_on:
      - controller-local-tmpfs
    environment:
      <<: *fortuna-env
      GIN_MODE: release
      LOG_LEVEL: WARN
    ports:
      - '8082:8082'
    profiles:
      - local-tmpfs

  virtio-local-tmpfs:
    <<: *virtio-common
    image: ${DEV_MACHINE_IP:-localhost}:5000/lokey-virtio:latest
    environment:
      <<: *virtio-env
      GIN_MODE: release
      LOG_LEVEL: WARN
    ports:
      - '8083:8083'  # HTTP API
    profiles:
      - local-tmpfs

volumes:
  api-data-local: